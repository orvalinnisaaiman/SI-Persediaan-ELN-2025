{% extends "base/base.html" %}
{% load static %}
{% load l10n %}

{% block content %}
<div class="page-header">
  <h3 class="page-title">Update Pengiriman</h3>
</div>

<div class="card">
  <div class="card-body">
    <h4 class="card-title mb-4">
      Pengiriman #{{ getdetailobj.id_pengiriman.id_pengiriman }}
      <small class="text">/ Detail #{{ getdetailobj.id_detail_pengiriman }}</small>
    </h4>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-3" role="alert">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" class="mt-2">
      {% csrf_token %}

      {# ====== INFO UTAMA PENGIRIMAN (urut: Customer → Tgl → Nomor SJ) ====== #}
      <div class="row">
        <div class="col-md-8">
          <div class="form-group">
            <label class="font-weight-bold">Customer</label>
            {# view expect: request.POST["nama_customer"] #}
            <select class="form-control" name="nama_customer" required>
              <option value="" disabled>Pilih customer…</option>
              {% for s in customerobj %}
                <option value="{{ s.id_customer }}"
                        {% if s.id_customer == getdetailobj.id_pengiriman.id_customer.id_customer %}selected{% endif %}>
                  {{ s.nama_customer }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="col-md-4">
          <div class="form-group">
            <label class="font-weight-bold">Tanggal Pengiriman</label>
            <input type="date"
                   class="form-control"
                   name="tanggal_pengiriman"
                   value="{{ getdetailobj.id_pengiriman.tanggal_pengiriman|date:'Y-m-d' }}"
                   required>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-group">
            <label class="font-weight-bold">Nomor Surat Jalan</label>
            {# text, bawa nilai dari create #}
            <input type="text"
                   class="form-control"
                   name="nomor_sj"
                   value="{{ getdetailobj.id_pengiriman.nomor_sj }}"
                   required>
          </div>
        </div>
      </div>

      <hr class="my-4">

      {# ====== DETAIL YANG DI-EDIT ====== #}
      <div class="row align-items-end">
        <div class="col-md-8">
          <div class="form-group">
            <label class="font-weight-bold mb-1">Nama Produk</label>
            <select class="form-control" name="nama_produk" required>
              <option value="" disabled>Pilih produk…</option>
              {% for b in produkobj %}
                <option value="{{ b.id_produk }}"
                        {% if b.id_produk == getdetailobj.id_produk.id_produk %}selected{% endif %}>
                  {{ b }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="col-md-4">
          <div class="form-group">
            <label class="font-weight-bold mb-1">Jumlah Produk Dikirim</label>
            <input type="text"
                   name="jumlah_produk_dikirim"
                   min="1"
                   value="{{ getdetailobj.jumlah_produk_dikirim|unlocalize }}"
                   class="form-control js-thousand"
                   inputmode="numeric"
                   autocomplete="off"
                   data-target="#qty_raw"
                   required>
              <input type="hidden" name="jumlah_produk_dikirim" id="qty_raw">
          </div>
        </div>
      </div>

      {# ====== TOMBOL AKSI ====== #}
      <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-success">
          <i class="ti-check mr-1"></i> Simpan Perubahan
        </button>
        <a href="{% url 'read_pengiriman' %}" class="btn btn-light">
          <i class="ti-arrow-left mr-1"></i> Batal
        </a>

        <a href="#"
           class="btn btn-outline-danger ml-auto btn-delete"
           data-url="{% url 'delete_detail_pengiriman' getdetailobj.id_detail_pengiriman %}"
           data-nama="Detail {{ getdetailobj.id_produk }} ({{ getdetailobj.jumlah_produk_dikirim }}) pada Pengiriman #{{ detail.id_pengiriman.id_pengiriman }}">
          <i class="ti-trash mr-1"></i> Hapus Detail Ini
        </a>
      </div>
    </form>
  </div>
</div>

{# Modal konfirmasi sederhana #}
<div class="modal fade" id="confirmDelete" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h4 class="title mb-2"></h4>
      <p class="text-muted mb-0">Data yang dihapus tidak bisa dikembalikan.</p>
      <div class="mt-3 d-flex gap-2">
        <button type="button" class="btn btn-danger btn-ya">Ya, hapus!</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('click', function(e){
  const trigger = e.target.closest('.btn-delete');
  if(!trigger) return;
  e.preventDefault();

  const url  = trigger.dataset.url;
  const nama = trigger.dataset.nama || '-';

  const modalEl = document.getElementById('confirmDelete');
  modalEl.querySelector('.title').textContent = `Yakin ingin menghapus ${nama}?`;
  modalEl.querySelector('.btn-ya').onclick = function(){ window.location.href = url; };

  bootstrap.Modal.getOrCreateInstance(modalEl).show();
});

(function(){
    const fmt = n => n.replace(/\D/g,'')
                      .replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    document.addEventListener('input', e => {
      const el = e.target.closest('.js-thousand');
      if (!el) return;
      const digits = el.value.replace(/\D/g,'');
      el.value = fmt(el.value);
      const target = document.querySelector(el.dataset.target);
      if (target) target.value = digits || '';
    });

    // jaga-jaga kalau user paste/blur
    document.addEventListener('blur', e => {
      const el = e.target.closest('.js-thousand');
      if (!el) return;
      el.value = fmt(el.value);
    }, true);

    // sebelum submit, pastikan hidden terisi & input tampilan tidak mengganggu
    document.addEventListener('submit', e => {
      e.target.querySelectorAll('.js-thousand').forEach(el => {
        const target = document.querySelector(el.dataset.target);
        if (target) target.value = el.value.replace(/\D/g,'') || '0';
      });
    }, true);
  })();
</script>
{% endblock %}
