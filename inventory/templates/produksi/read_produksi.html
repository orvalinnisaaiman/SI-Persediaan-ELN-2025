{% extends "base/base.html" %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="page-title mb-0">Data Produksi</h3>
  {% if is_ppic or is_produksi%}
  <a href="{% url 'create_produksi' %}" class="btn btn-sm btn-success text-white">
    <i class="ti-plus mr-1"></i> Tambah Data Produksi
  </a>
  {% endif %}
</div>

<div class="card">
  <div class="card-body">
    <!-- FILTER -->
    <form method="get" class="mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label mb-1">Tanggal Mulai</label>
          <input type="date" class="form-control" name="tmin" value="{{ tmin|default_if_none:'' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Tanggal Akhir</label>
          <input type="date" class="form-control" name="tmax" value="{{ tmax|default_if_none:'' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Nama Produk</label>
          <select class="form-control" name="produk">
            <option value="">— Semua Produk —</option>
            {% for pr in produkobj %}
              <option value="{{ pr.id_produk }}" {% if produk_sel == pr.id_produk|stringformat:"s" %}selected{% endif %}>
                {{ pr }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="mt-2 d-flex align-items-center">
          <button type="submit" class="btn btn-primary btn-sm" style="margin-right: 8px">
            <i class="ti-search mr-1"></i> Filter
          </button>
          <a href="{% url 'read_produksi' %}" class="btn btn-light btn-sm">
            <i class="ti-reload mr-1"></i> Reset
          </a>
        </div>
      </div>
    </form>

    <!-- TABEL -->
    <div class="table-responsive mt-2">
      <table class="table table-bordered table-hover">
        <thead class="thead-light">
          <tr>
            <th class="text-center">No</th>
            <th class="text-center">Tanggal Produksi</th>
            <th class="text-center">Nama Produk</th>
            <th class="text-center">Kuantitas Produk</th>
            <th class="text-center">Nama Bahan Baku</th>
            <th class="text-center">Kuantitas Bahan Baku</th>
            <th class="text-center">Jumlah Reject</th>
            <th class="text-center">Jumlah Finished Goods</th>
            <th class="text-center">Status QC</th>
            {% if is_ppic or is_produksi or is_qc %}
            <th class="text-center" style="width:260px;">Aksi</th>
            {% endif %}
          </tr>
        </thead>

        <tbody>
        {% for p in produksiobj %}
          {% with details=p.detail_produksi_set.all %}
            {% if details|length %}
              {% for d in details %}
              <tr>
                {% if forloop.first %}
                  <td class="text-center align-middle" rowspan="{{ details|length }}">{{ forloop.parentloop.counter }}</td>
                  <td class="text-center align-middle" rowspan="{{ details|length }}">{{ p.tanggal_produksi }}</td>
                {% endif %}

                <td class="align-middle">{{ d.id_produk }}</td>
                <td class="text-end align-middle">{{ d.jumlah_produk }}</td>
                <td class="align-middle">{{ d.id_bahan }}</td>
                <td class="text-end align-middle">{{ d.jumlah_bahan_keluar }}</td>
                <td class="text-end align-middle">{{ d.jumlah_reject|default:"-" }}</td>
                <td class="text-end align-middle">{{ d.jumlah_fg|default:"-" }}</td>
                <td class="text-center align-middle">
                  {% if d.status_qc == 'sudah' %}
                    <span class="badge badge-success">Sudah diperiksa</span>
                  {% elif d.status_qc == 'sedang' %}
                    <span class="badge badge-warning">Sedang diperiksa</span>
                  {% else %}
                    <span class="badge badge-secondary">Belum diperiksa</span>
                  {% endif %}
                </td>


                {% if is_ppic or is_produksi or is_qc %}
                <td class="text-center align-middle">
                  <div class="btn-grid">
                    {% if is_ppic or is_produksi %}
                    <a href="{% url 'update_produksi' d.id_detail_produksi %}"
                       class="btn btn-xs btn-outline-primary">
                      <i class="ti-pencil"></i> Edit Produksi
                    </a>
                    {% endif %}

                    {% if is_ppic or is_qc %}
                    <a href="{% url 'update_qc_produksi' d.id_detail_produksi %}"
                       class="btn btn-xs btn-outline-success">
                      <i class="ti-check-box"></i> Input QC
                    </a>
     
                    <!-- DROPDOWN SET STATUS -->
                   
                    <div class="dropdown d-inline">
                      <button class="btn btn-xs btn-outline-warning dropdown-toggle"
                              type="button"
                              data-toggle="dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Status: {% if d.status_qc == 'sudah' %}Sudah{% elif d.status_qc == 'sedang' %}Sedang{% else %}Belum{% endif %}
                      </button>
                      <div class="dropdown-menu">
                        <a class="dropdown-item qc-set-status {% if d.status_qc == 'belum' %}disabled{% endif %}"
                          href="#" data-status="belum" aria-disabled="{% if d.status_qc == 'belum' %}true{% else %}false{% endif %}">
                          Belum diperiksa
                        </a>
                        <a class="dropdown-item qc-set-status {% if d.status_qc == 'sedang' %}disabled{% endif %}"
                          href="#" data-status="sedang" aria-disabled="{% if d.status_qc == 'sedang' %}true{% else %}false{% endif %}">
                          Sedang diperiksa
                        </a>
                        <a class="dropdown-item qc-set-status {% if d.status_qc == 'sudah' %}disabled{% endif %}"
                          href="#" data-status="sudah" aria-disabled="{% if d.status_qc == 'sudah' %}true{% else %}false{% endif %}">
                          Sudah diperiksa
                        </a>
                      </div>

                      <!-- Satu form POST tersembunyi untuk submit status -->
                      <form method="post"
                            action="{% url 'set_qc_status' d.id_detail_produksi %}"
                            class="d-none qc-status-form">
                        {% csrf_token %}
                        <input type="hidden" name="status" value="">
                      </form>
                    </div>
                    {% endif %}

                    {% if is_ppic or is_produksi %}
                    <button type="button"
                            class="btn btn-xs btn-outline-danger btn-delete"
                            data-url="{% url 'delete_detail_produksi' d.id_detail_produksi %}"
                            data-nama="Detail: {{ d.id_produk }} | {{ d.id_bahan }} (produk: {{ d.jumlah_produk }}, bahan: {{ d.jumlah_bahan_keluar }}) pada Produksi #{{ p.id_produksi }} {{ p.tanggal_produksi }}">
                      <i class="ti-trash"></i> Hapus Detail
                    </button>

                    {% if forloop.first %}
                    <button type="button"
                            class="btn btn-xs btn-outline-danger btn-delete"
                            data-url="{% url 'delete_produksi' p.id_produksi %}"
                            data-nama="Produksi #{{ p.id_produksi }} — {{ p.tanggal_produksi }} [HAPUS SEMUA DETAIL]">
                      <i class="ti-close"></i> Hapus Semua
                    </button>
                    {% endif %}
                    {% endif %}
                  </div>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td class="text-center">{{ forloop.counter }}</td>
                <td class="text-center">{{ p.tanggal_produksi }}</td>
                <td colspan="{% if is_ppic or is_produksi or is_qc %}7{% else %}6{% endif %}" class="text-muted">
                  Belum ada detail.
                </td>
              </tr>
            {% endif %}
          {% endwith %}
        {% empty %}
          <tr>
            <td colspan="{% if is_ppic or is_produksi or is_qc %}9{% else %}8{% endif %}" class="text-center text-muted">
              Belum ada data produksi.
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal konfirmasi hapus (satu untuk semua) -->
<div class="modal fade" id="confirmDelete" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <h4 class="title mb-2"></h4>
        <p class="text-muted mb-0">Data yang dihapus tidak bisa dikembalikan.</p>
        <div class="mt-3 d-flex gap-2">
          <button type="submit" class="btn btn-danger">Ya, hapus!</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  if (window.__bindDeleteOnceUniversal) return;
  window.__bindDeleteOnceUniversal = true;

  var modalEl = document.getElementById('confirmDelete');
  var formEl  = document.getElementById('deleteForm');
  var titleEl = modalEl.querySelector('.title');

  function showModal(){
    try {
      if (window.bootstrap && bootstrap.Modal) {
        bootstrap.Modal.getOrCreateInstance(modalEl).show();   // BS5
      } else if (window.jQuery) {
        jQuery(modalEl).modal('show');                          // BS4
      } else {
        alert('Konfirmasi tidak bisa dibuka (library modal tidak ditemukan).');
      }
    } catch (e) {
      if (window.jQuery) jQuery(modalEl).modal('show'); else alert('Konfirmasi gagal dibuka.');
    }
  }

  document.addEventListener('click', function(e){
    var btn = e.target.closest('.btn-delete');
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    var url = btn.dataset.url;
    if (!url || url === 'null' || /\/null\/?$/.test(url)) {
      console.error('Delete URL invalid:', btn);
      alert('Gagal membuka konfirmasi: ID tidak ditemukan.');
      return;
    }
    formEl.action = url;  // <- set action POST ke endpoint delete
    titleEl.textContent = 'Yakin ingin menghapus ' + (btn.dataset.nama || 'data ini') + '?';
    showModal();
  }, true);
})();
</script>

<script>
(function(){
  // Klik item dropdown -> isi hidden input lalu submit form
  document.addEventListener('click', function(e){
    const a = e.target.closest('.qc-set-status');
    if (!a) return;

    // Honor "disabled" visual state
    if (a.classList.contains('disabled') || a.getAttribute('aria-disabled') === 'true') {
      e.preventDefault(); return;
    }

    e.preventDefault();
    const status = (a.dataset.status || '').toLowerCase();

    // Cari wrapper dropdown & form tersembunyi
    const wrap = a.closest('.dropdown');
    const form = wrap?.querySelector('.qc-status-form');
    if (!form) return;

    // Cek cepat ketika memilih "sudah": reject + fg harus == jumlah_produk
    if (status === 'sudah') {
      const tr = a.closest('tr');
      const target = parseInt(tr?.dataset.jumlahProduk || '0', 10);
      const jr = parseInt(tr?.dataset.jumlahReject || '0', 10);
      const fg = parseInt(tr?.dataset.jumlahFg || '0', 10);
      if ((jr + fg) !== target) {
        alert(`Tidak bisa set "Sudah diperiksa". Total (Reject + FG = ${jr + fg}) ≠ Jumlah Produk (${target}). ` +
              `Lengkapi QC dulu lewat tombol "QC".`);
        return;
      }
    }

    // Set value & submit
    const input = form.querySelector('input[name="status"]');
    input.value = status;
    form.submit();
  }, true);
})();
</script>


<!-- ALIGNMENT SCRIPT (sama seperti pengiriman) -->
<script>
(function(){
  if (window.__bindDeleteOnce) return;
  window.__bindDeleteOnce = true;

  const modalEl = document.getElementById('confirmDelete');
  const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
  const titleEl = modalEl.querySelector('.title');
  const formEl  = document.getElementById('deleteForm');

  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-delete');
    if (!btn) return;
    e.preventDefault();
    e.stopImmediatePropagation();

    const url  = btn.dataset.url;
    const nama = btn.dataset.nama || '-';
    formEl.action = url;
    titleEl.textContent = `Yakin ingin menghapus ${nama}?`;
    bsModal.show();
  }, true);
})();
</script>

<!-- POLYFILL CSS kecil kalau masih Bootstrap 4 -->
<style>
  .btn-xs { padding: .2rem .45rem; font-size: .75rem; line-height: 1.2; border-radius: .2rem; }
  /* Gap util: jika BS4, tidak ada .gap-1 */
  .gap-1 > * { margin: .125rem; }
  .gap-2 > * { margin: .25rem; }
</style>

<!-- GRID BUTTON ACTION -->
<style>
  /* Grid tombol 2x3 biar rapi */
  .btn-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-auto-rows: auto;
    gap: 0.3rem;
    justify-items: stretch;
    align-items: stretch;
  }
  .btn-grid .btn {
    white-space: nowrap;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }

  /* Perluas dropdown biar sejajar dengan tombol lain */
  .btn-grid .dropdown .dropdown-toggle {
    width: 100%;
  }

  .btn-grid .dropdown-menu {
    font-size: 0.8rem;
    min-width: max-content;
  }
</style>

{% endblock %}
