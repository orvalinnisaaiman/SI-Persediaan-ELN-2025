{% extends "base/base.html" %}
{% load static %}
{% load l10n %}

{% block content %}
<div class="page-header">
  <h3 class="page-title">Update Produksi</h3>
</div>

<div class="card">
  <div class="card-body">
    <h4 class="card-title mb-4">
      Produksi #{{ getdetailobj.id_produksi.id_produksi }}
      <small class="text">/ Detail #{{ getdetailobj.id_detail_produksi }}</small>
    </h4>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-3" role="alert">{{ message }}</div>
      {% endfor %}
    {% endif %}

    {# Halaman ini HANYA untuk PPIC & Produksi, jadi tidak ada field QC di sini #}
    <form method="post" class="mt-2 form-sample">
      {% csrf_token %}

      <!-- INFO UTAMA PRODUKSI -->
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label class="font-weight-bold">Tanggal Produksi</label>
            <input type="date"
                   class="form-control"
                   name="tanggal_produksi"
                   value="{{ tanggal_produksi }}"
                   required>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <!-- DETAIL YANG DI-EDIT (tanpa field QC) -->
      <div class="row align-items-end">
        <div class="col-md-6">
          <div class="form-group">
            <label class="font-weight-bold mb-1">Nama Produk</label>
            <select class="form-control" name="nama_produk" required>
              <option value="" disabled>Pilih produk…</option>
              {% for p in produkobj %}
                <option value="{{ p.id_produk }}"
                        {% if p.id_produk == getdetailobj.id_produk.id_produk %}selected{% endif %}>
                  {{ p }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-group">
            <label class="font-weight-bold mb-1">Nama Bahan Baku</label>
            <select class="form-control" name="nama_bahan" required>
              <option value="" disabled>Pilih bahan…</option>
              {% for b in bahanobj %}
                <option value="{{ b.id_bahan }}"
                        {% if b.id_bahan == getdetailobj.id_bahan.id_bahan %}selected{% endif %}>
                  {{ b }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-group">
            <label class="font-weight-bold mb-1">Kuantitas Produk Dihasilkan</label>
            <input type="text"
                  inputmode="numeric"
                  class="form-control js-thousand"
                  name="jumlah_produk"
                  min="1"
                  step="1"
                  value="{{ getdetailobj.jumlah_produk|unlocalize }}"
                  required>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-group">
            <label class="font-weight-bold mb-1">Kuantitas Bahan Baku Digunakan</label>
            <input type="text"
                  inputmode="numeric"
                  class="form-control js-thousand"
                  name="jumlah_bahan_keluar"
                  min="1"
                  step="1"
                  value="{{ getdetailobj.jumlah_bahan_keluar|unlocalize }}"
                  required>
          </div>
        </div>

        {# TIDAK ADA input jumlah_reject & jumlah_fg di halaman ini #}
      </div>

      <!-- TOMBOL AKSI -->
      <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-success">
          <i class="ti-check mr-1"></i> Simpan Perubahan
        </button>
        <a href="{% url 'read_produksi' %}" class="btn btn-light">
          <i class="ti-arrow-left mr-1"></i> Batal
        </a>

        {% if is_ppic or is_produksi %}
        <!-- Hapus detail ini dari halaman update (PPIC/Produksi saja) -->
        <a href="#"
           class="btn btn-outline-danger ml-auto btn-delete"
           data-url="{% url 'delete_detail_produksi' id_detail=getdetailobj.id_detail_produksi %}"
           data-nama="Detail: {{ getdetailobj.id_produk }} | {{ getdetailobj.id_bahan }} (produk: {{ getdetailobj.jumlah_produk }}, bahan: {{ getdetailobj.jumlah_bahan_keluar }}) pada Produksi #{{ getdetailobj.id_produksi.id_produksi }}">
          <i class="ti-trash mr-1"></i> Hapus Detail Ini
        </a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<!-- Modal konfirmasi hapus -->
<div class="modal fade" id="confirmDelete" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h4 class="title mb-2"></h4>
      <p class="text-muted mb-0">Data yang dihapus tidak bisa dikembalikan.</p>
      <div class="mt-3 d-flex gap-2">
        <button type="button" class="btn btn-danger btn-ya">Ya, hapus!</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('click', function(e){
  const trigger = e.target.closest('.btn-delete');
  if(!trigger) return;
  e.preventDefault();

  const url  = trigger.dataset.url;
  const nama = trigger.dataset.nama || '-';

  const modalEl = document.getElementById('confirmDelete');
  modalEl.querySelector('.title').textContent = `Yakin ingin menghapus ${nama}?`;
  modalEl.querySelector('.btn-ya').onclick = function(){ window.location.href = url; };

  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
});
</script>
{% endblock %}
