{# templates/stok_opname/read_detail_so_produk.html #}
{% extends "base/base.html" %}
{% load static %}
{% block content %}
<div class="page-header">
  <h3 class="page-title">Detail Stok Opname Produk #{{ so.id_stok_opname }}</h3>
</div>

<div class="card">
  <div class="card-body">
    <div class="mb-3">
      <div><strong>Tanggal:</strong> {{ so.tanggal_stok_opname }}</div>
    </div>

  <div class="table-responsive">
    <table class="table table-bordered">
      <thead class="thead-light">
        <tr>
          <th class="text-center">No</th>
          <th>Produk</th>
          <th class="text-center">Stok Fisik</th>
          {% if is_ppic %}<th class="text-center">Action</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for d in details %}
        <tr>
          <td class="text-center">{{ forloop.counter }}</td>
          <td>{{ d.id_produk.nama_produk }}</td>
          <td class="text-center">{{ d.stok_fisik_produk }}</td>
          {% if is_ppic %}
          <td class="text-center">
            <a class="btn btn-xs btn-outline-primary"
               href="{% url 'update_detail_so_produk' d.id_detail_so_produk %}"><i class="ti-pencil"></i> Edit</a>
            <button type="button" class="btn btn-xs btn-outline-danger btn-delete"
                    data-url="{% url 'delete_detail_so_produk' d.id_detail_so_produk %}?next={{ request.get_full_path|urlencode }}"
                    data-nama="Detail #{{ d.id_detail_so_produk }} ({{ d.id_produk.nama_produk }})">
              <i class="ti-trash"></i> Hapus
            </button>
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if is_ppic %}4{% else %}3{% endif %}" class="text-center text-muted">Belum ada detail.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div></div>

<!-- Modal konfirmasi hapus -->
<div class="modal fade" id="confirmDelete" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <h4 class="title mb-2"></h4>
        <p class="text-muted mb-0">Data yang dihapus tidak bisa dikembalikan.</p>
        <div class="mt-3 d-flex gap-2">
          <button type="submit" class="btn btn-danger">Ya, hapus!</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  if (window.__bindDeleteOnceUniversal) return;
  window.__bindDeleteOnceUniversal = true;

  var modalEl = document.getElementById('confirmDelete');
  var formEl  = document.getElementById('deleteForm');
  var titleEl = modalEl.querySelector('.title');

  function showModal(){
    try {
      if (window.bootstrap && bootstrap.Modal) {
        bootstrap.Modal.getOrCreateInstance(modalEl).show();   // BS5
      } else if (window.jQuery) {
        jQuery(modalEl).modal('show');                          // BS4
      } else {
        alert('Konfirmasi tidak bisa dibuka (library modal tidak ditemukan).');
      }
    } catch (e) {
      if (window.jQuery) jQuery(modalEl).modal('show'); else alert('Konfirmasi gagal dibuka.');
    }
  }

  document.addEventListener('click', function(e){
    var btn = e.target.closest('.btn-delete');
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    var url = btn.dataset.url;
    if (!url || url === 'null' || /\/null\/?$/.test(url)) {
      console.error('Delete URL invalid:', btn);
      alert('Gagal membuka konfirmasi: ID tidak ditemukan.');
      return;
    }
    formEl.action = url;  // <- set action POST ke endpoint delete
    titleEl.textContent = 'Yakin ingin menghapus ' + (btn.dataset.nama || 'data ini') + '?';
    showModal();
  }, true);
})();
</script>
{% endblock %}
